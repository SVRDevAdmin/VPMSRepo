@inject VPMSCustomer.Interface.IResourcesLocalizer LangResources
@inject IHttpContextAccessor httpContextaccessor

@{
    ViewData["Title"] = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var sessionPatientID = httpContextaccessor.HttpContext.Session.GetString("PatientID");
    var sessionUserName = httpContextaccessor.HttpContext.Session.GetString("UserName");

    var appointmentSelected = (long)ViewData["appointmentSelected"];
}

<link rel="stylesheet" href="~/css/font-awesome.min.css">
<link rel="stylesheet" href="~/css/gijgo.min.css" type="text/css" />
<link rel="stylesheet" href="~/lib/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css" type="text/css" />

<script src="~/lib/datepicker/gijgo.min.js" type="text/javascript"></script>
<script src="~/lib/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>


<style>
.bootstrap-datetimepicker-widget {
    width: 200px !important;
}

#ddlPets:disabled{
    background: grey !important;
    border-color: grey !important;
}

</style>
<script type="text/javascript">
    $(document).ready(function(){
        /*----- initiate Date Picker -----*/
        $('#dtAppt').datepicker({
             uiLibrary: 'bootstrap5',
             format: 'dd/mm/yyyy'
        });

        $('.gj-icon').parent().hide();
        $('.gj-icon').hide();

        /*----- initiate TimePicker --------*/
        $('#dtStart').datetimepicker({
             useCurrent: false,
             format: 'HH:mm',
             icons: {
                 up: 'fa fa-angle-up',
                 down: 'fa fa-angle-down'
             }
        }).on('dp.show', function () {
             time = "09:00 AM";
             //$(this).data('DateTimePicker').date(time);
             $(this).data('DateTimePicker').minDate(time);
        }).on('dp.change', function () {
             var min_endtime = $(this).val();
             var min_time = moment(min_endtime, "HH:mm TT").add(30, 'minutes').format('HH:mm');

             $('#dtEnd').val(min_time);
        });

        $('#dtEnd').datetimepicker({
            useCurrent: false,
            format: 'HH:mm',
            icons: {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            }
        }).on('dp.show', function () {
            var starttime = $('#dtStart').val();
            var min_starttime = moment(starttime, "HH:mm TT").add(30, 'minutes').format('HH:mm');

            $(this).data('DateTimePicker').date(min_starttime);
            $(this).data('DateTimePicker').minDate(min_starttime);
        });


        LoadPetDropdownList();
        LoadBranchDropdownList();

        setTimeout(function(){
            LoadAppointmentDetails();
        }, 200);
    });

    function LoadPetDropdownList(){
        $.getJSON("/Pets/GetPetsList/" + '@sessionPatientID')
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlPets').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlPets').append(opt);
                 }
             }
             else {
                 $('#ddlPets').find("option:not(:first)").remove();
             }
         })
    }

    function LoadBranchDropdownList(){
        $.getJSON("/Masterdata/BranchList/-1")
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlClinic').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlClinic').append(opt);
                 }
             }
             else{
                 $('#ddlClinic').find("option:not(:first)").remove();
             }
         });
    }

    function LoadServicesDropdownList(clinic)
    {
        $.getJSON("/Masterdata/ServiceList/" + clinic.value)
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlServices').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlServices').append(opt);
                 }
             }
             else 
             {
                 $('#ddlServices').find("option:not(:first)").remove();
             }
         });
    }

    function LoadDoctorDropdownList(service)
    { 
        $.getJSON("/Masterdata/DoctorListByService/" + service.value)
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlDoctor').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlDoctor').append(opt);
                 }
             }
             else 
             {
                 $('#ddlDoctor').find("option:not(:first)").remove();
             }
         });
    }

    function LoadAppointmentDetails()
    {
        $.getJSON("/Appointment/GetAppointmentDetail/" + '@appointmentSelected')
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 var sApptRow = result.data[0];

                 $('#ddlPets').val(sApptRow.petID);
                 $('#ddlPets').attr('disabled','disabled');
                 $('#dtAppt').val(moment(sApptRow.apptDate).format("DD/MM/YYYY"));
                 $('#dtStart').val(moment(sApptRow.apptStartTime, 'hh:mm:ss').format('HH:mm'));
                 $('#dtEnd').val(moment(sApptRow.apptEndTime, 'hh:mm:ss').format('HH:mm'));

                 $('#ddlClinic').val(sApptRow.branchID);
                 $('#ddlClinic').trigger('change');

                 setTimeout(function(){
                     $('#ddlServices').val(sApptRow.servicesID);
                     $('#ddlServices').trigger('change');

                     setTimeout(function(){
                        $('#ddlDoctor option:contains("' + sApptRow.inchargeDoctor + '")').attr('selected', true);
                     }, 500);
                 }, 500);
                 
             }
         });
    }

    function updateAppointment()
    {
        $.post("/Appointment/UpdateAppointmentDetails", {
            appointmentID: '@appointmentSelected',
            branchID: $('#ddlClinic').val(),
            appointmentDate: $('#dtAppt').val(),
            startTime: $('#dtStart').val(),
            endTime: $('#dtEnd').val(),
            servicesID: $('#ddlServices').val(),
            inchargeDoctor: $('#ddlDoctor option:selected').text(),
            updatedBy: '@sessionUserName'
        }).done(function(result){
            if (result.statusCode == 200){
                ShowSuccessMsgBox("Update Appointment", "Appointment update successfully.",
                    function(){
                        window.location.href = '/Appointment/Index';
                    }
                );
            }
            else 
            {
                if (result.isOverlap)
                {
                    ShowSuccessMsgBox("Update Appointment", "Appointment date time slot occupied, please try again with other time slot",
                        function(){}
                    );
                }
                else{
                    ShowSuccessMsgBox("Update Appointment", "Failed to update appointment, please try again later.",
                        function(){}
                    );
                }

            }
        })
    }

    function cancelAppointment()
    { 
        ShowConfirmCancelMsgBox("Cancel Appointment", "Confirm cancel this appointment?",
            function(){
                $.post("/Appointment/UpdateAppointmentStatus", {
                    appointmentID: '@appointmentSelected',
                    sUpdatedBy : '@sessionUserName'
                }).done(function(result){
                    if (result){
                        ShowSuccessMsgBox("Cancel Appointment", "Appointment Cancelled.",
                            function(){
                                window.location.href = '/Appointment/Index';
                            }
                        );
                    }
                    else {
                        ShowSuccessMsgBox("Cancel Appointment", "Failed to cancel appointment, please try again later.",
                            function(){}
                        );
                    }
                });
            },
            function() {}
        );

    }

    function backToMainPage(){
        window.location.href = '/Appointment/Index';
    }
</script>

<div class="row ms-3">
    <div class="row pt-4">
        <div class="col-md-12">
            <label class="pageTitle">
                Edit Appointments
            </label>
        </div>
    </div>
    <div class="row mt-4" style="border: 0px solid black;">
        <div class="col-md-9" style="border: 0px solid black;">
            <div class="row me-1" style="background-color: #1e76fc; border-radius: 6px;">
                <div class="row mt-3">
                    <div class="col-md-12 ms-3">
                        <label style="font-size: 14px; font-weight: bold; color: white;">Edit Appointment Details</label>
                    </div>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row" >
                    <div class="col-md-6" style="border: 0px solid black;">
                        <label class="ms-3" style="font-size: 12px; font-weight: bold; color: white;">Pets</label>
                    </div>
                    <div class="col-md-6" style="border: 0px solid black;">
                        <label class="ms-3" style="font-size: 12px; font-weight: bold; color: white;">Clinic</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <select id="ddlPets" class="form-select form-select-sm ms-3" style="width: 90%;">
                            <option value="">Select Pet</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <select id="ddlClinic" class="form-select form-select-sm ms-3" style="width: 90%;" onchange="LoadServicesDropdownList(this);">
                            <option value="">Select Clinic</option>
                        </select>
                    </div>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row">
                    <div class="col-md-6">
                        <label class="ms-3" style="font-size: 12px; font-weight: bold; color: white;">Services</label>
                    </div>
                    <div class="col-md-6">
                        <label class="ms-3" style="font-size: 12px; font-weight: bold; color: white;">Date</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <select id="ddlServices" class="form-select form-select-sm ms-3" style="width: 90%;" onchange="LoadDoctorDropdownList(this);">
                            <option value="">Select Services</option>
                        </select>
                    </div>
                    <div class="col-md-6" style="display: flex; flex-direction: row;">
                        <div class="ms-3 me-1" style="width: 40%;">
                            <input id="dtAppt" class="form-control-sm" />
                        </div>
                        <div style="width: 50%; height: 30px; display: flex; flex-direction: row; border-top-right-radius: 6px; border-bottom-right-radius: 6px; border: 0px solid black; background-color: white;">
                            <input id="dtStart" class="form-control-sm" style="width: 40%; background-color: transparent; text-align: center; border: 0;" />
                            <div style="width: 5%; text-align: center; color: grey">--</div>
                            <input id="dtEnd" class="form-control-sm" style="width: 40%; background-color: transparent; text-align: center; border: 0;" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label class="ms-3" style="font-size: 12px; font-weight: bold; color: white;">Doctor</label>
                    </div>
                    <div class="col-md-6">&nbsp;</div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <select id="ddlDoctor" class="form-select form-select-sm ms-3" style="width: 90%;">
                            <option value="">Select Doctor</option>
                        </select>
                    </div>
                    <div class="col-md-6">&nbsp;</div>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
            </div>
            <div class="row mt-3 me-1" style="border: 0px solid black;">
                <div class="row justify-content-end">
                    <button id="btnBack" class="btn btn-secondary" onclick="backToMainPage();" style="font-size: 12px; width: 20%;">Back</button>&nbsp;
                    <button id="btnCancel" class="btn btn-danger" onclick="cancelAppointment();" style="font-size: 12px; width: 20%;">Cancel Appointment</button>&nbsp;
                    <button id="btnUpdate" class="btn btn-primary" onclick="updateAppointment();" style="font-size: 12px; width: 20%;">Update</button>
                </div>
            </div>
        </div>

        <div class="col-md-3" style="border: 0px solid black;">
            <div class="row" style="background-color: #f7f7f7; border-radius: 6px; height: stretch;">
                <div class="row mt-4">
                    <label class="ms-2 me-1" style="font-size: 17px; border: 0px solid black;">Would you like to contact the clinic instead?</label>
                </div>
                <div class="row">&nbsp;</div>
                <div class="row" style="display: flex; flex-direction: row;">
                    <span>
                        <i class="bi bi-envelope ms-2 me-1"></i>
                        <label style="font-size: 15px; word-wrap: break-word;">Send a message</label>
                    </span>

                </div>
                <div class="row" style="display: flex; flex-direction: row;">
                    <span>
                        <i class="bi bi-telephone ms-2 me-1"></i>
                        <label style="font-size: 15px; word-wrap: break-word;">Or call +012313432444</label>
                    </span> 
                </div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
                <div class="row">&nbsp;</div>
            </div>
        </div>
    </div>
</div>

