@inject VPMSCustomer.Interface.IResourcesLocalizer LangResources
@inject IHttpContextAccessor httpContextaccessor

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var sessionPatientID = httpContextaccessor.HttpContext.Session.GetString("PatientID");
    var sessionPatientOwnerID = httpContextaccessor.HttpContext.Session.GetString("PatientOwnerID");
    var sessionUserID = httpContextaccessor.HttpContext.Session.GetString("UserID");
    var sessionUserName = httpContextaccessor.HttpContext.Session.GetString("UserName");
}

<link rel="stylesheet" href="~/css/font-awesome.min.css">
<link rel="stylesheet" href="~/css/gijgo.min.css" type="text/css" />
<link rel="stylesheet" href="~/lib/bootstrap-datetimepicker/css/bootstrap-datetimepicker.css" type="text/css" />

<script src="~/lib/datepicker/gijgo.min.js" type="text/javascript"></script>
<script src="~/lib/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>

<style>
    #ddlViewSelection:focus, #ddlViewSelection:active{
        border: none;
    }

    #ulViewSelection > li {
        font-size: 12px;
    }
</style>

<script type="text/javascript">
    var statusConfirmed = 0;
    var statusCompleted = 1;
    var statusPendingAppr = 3;
    var statusPendingAccpt = 4;

    $(document).ready(function(){
        /*----- initiatie date picker -----*/
        $('#dtDate').datepicker({
             uiLibrary: 'bootstrap5',
             format: 'dd/mm/yyyy'
        });

        $('.gj-icon').parent().hide();

        $('#tmStart').datetimepicker({
             useCurrent: false,
             format: 'HH:mm',
             icons: {
                 up: 'fa fa-angle-up',
                 down: 'fa fa-angle-down'
             }
        }).on('dp.show', function () {
             time = "09:00 AM";
             //$(this).data('DateTimePicker').date(time);
             $(this).data('DateTimePicker').minDate(time);
        }).on('dp.change', function () {
            debugger;
             var min_endtime = $(this).val();
             var min_time = moment(min_endtime, "HH:mm TT").add(30, 'minutes').format('HH:mm');

             $('#tmEnd').val(min_time);
        });

        $('#tmEnd').datetimepicker({
            useCurrent: false,
            format: 'HH:mm',
            icons: {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            }
        }).on('dp.show', function () {
            debugger;
            var starttime = $('#tmStart').val();
            var min_starttime = moment(starttime, "HH:mm TT").add(30, 'minutes').format('HH:mm');

            $(this).data('DateTimePicker').date(min_starttime);
            $(this).data('DateTimePicker').minDate(min_starttime);
        });

        // // ---- Booking Buttton ---------//
        // $('#btnBook').on('click', function()
        // {
        //     if (ValidAppointmentSubmit())
        //     {

        //     }
        //     else
        //     {
        //         $('#lbError').html('Mandatory fields required.');
        //     }
        // })

        LoadPetsDropdownList();
        LoadBranchDropdownList();

        LoadAppointmentGrouping();
        LoadAppointments('All', 'All');
    });

    function LoadPetsDropdownList()
    {
        $.getJSON("/Pets/GetPetsList/" + '@sessionPatientID')
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlPets').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlPets').append(opt);
                 }
             }
             else {
                 $('#ddlPets').find("option:not(:first)").remove();
             }
         })
    }

    function LoadBranchDropdownList()
    {
        $.getJSON("/Masterdata/BranchList/-1")
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlClinic').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlClinic').append(opt);
                 }
             }
             else{
                 $('#ddlClinic').find("option:not(:first)").remove();
             }
         });
    }

    function LoadServicesDropdownList(clinic)
    {
        $.getJSON("/Masterdata/ServiceList/" + clinic.value)
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlServices').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlServices').append(opt);
                 }
             }
             else
             {
                 $('#ddlServices').find("option:not(:first)").remove();
             }
         });
    }

    function LoadDoctorDropdownList(service)
    { 
        $.getJSON("/Masterdata/DoctorListByService/" + service.value)
         .done(function(result){
             if (result != null && result.data.length > 0)
             {
                 $('#ddlDoctor').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].name), result.data[i].id);
                     $('#ddlDoctor').append(opt);
                 }
             }
             else
             {
                 $('#ddlDoctor').find("option:not(:first)").remove();
             }
         });
    }

    function LoadAppointmentGrouping()
    {
        $('#ulViewSelection').children("li:not(:first)").remove();

        $.getJSON("/Appointment/GetAppointmentGrouping", {
            appointmentGroup : 'AppointmentView'
        }).done(function(result){
            if (result != null && result.data.length > 0)
            {
                for (var i = 0; i < result.data.length; i++)
                {
                    var sDropdownMenu = '';
                    sDropdownMenu = '<li><a class="dropdown-item" onclick="LoadAppointments(\'' + result.data[i].appointmentSubGrpValue + '\', \'' + result.data[i].appointmentSubGroup + '\');">' +  result.data[i].appointmentSubGroup + '</a></li>';

                    $('#ulViewSelection').append(sDropdownMenu);
                }
            }
        })
    }

    function LoadAppointments(sViewSelection, sViewName)
    {
        $('#divRescheduled').html('');
        $('#divConfirmed').html('');
        $('#divPast').html('');

        $.getJSON("/Appointment/GetViewListing/" + '@sessionPatientID')
         .done(function(result){ 
             if (result != null && result.data.length > 0)
             {
                 // Pending Status Appointment
                if (sViewSelection == 'All' || sViewSelection == '1')
                {      
                    var stringPending = 'Pending';
                    var sPendingGroup = result.data.filter(function(obj){
                                            return (obj.status == statusPendingAppr || obj.status == statusPendingAccpt);
                                        });

                    if (sPendingGroup.length > 0)
                    {
                        for (var i = 0; i < sPendingGroup.length; i++)
                        {
                             $('#divRescheduled').append(generateAppointmentGrid(sPendingGroup[i], stringPending, '#ffc5c4', '#f18d8b'));
                        }
                    }
                    else
                    {
                        $('#divRescheduled').append(generateEmptyGrid());
                    }

                    $('#divParentRescheduled').show();
                }
                else
                {
                    $('#divParentRescheduled').hide();
                }

                // Confirmed Status Appointment
                if (sViewSelection == 'All' || sViewSelection == '2')
                {
                    
                    var stringConfirmed = 'Confirmed';
                    var sConfirmedGroup = result.data.filter(function(obj){
                                            return (obj.status == statusConfirmed);
                                        });
                    if (sConfirmedGroup.length > 0)
                    {
                         for (var x = 0; x < sConfirmedGroup.length; x++)
                         {
                            $('#divConfirmed').append(generateAppointmentGrid(sConfirmedGroup[x], stringConfirmed, '#c2f7ea', '#7ac1b3'));
                         }
                    }
                    else 
                    {
                        $('#divConfirmed').append(generateEmptyGrid());
                    }

                    $('#divParentConfirmed').show();
                }
                else
                {
                    $('#divParentConfirmed').hide();
                }

                // Past Status Appointment
                if (sViewSelection == 'All' || sViewSelection == '3')
                {
                    var sPastGroup = result.data.filter(function(obj){
                                            return (obj.status == statusCompleted);
                                        });

                    if (sPastGroup.length > 0)
                    {
                        for (var x = 0; x < sPastGroup.length; x++)
                        {
                             $('#divPast').append(generateAppointmentGrid(sPastGroup[x], '', '#c6c6c6', '#c6c6c6'));
                        }
                    }
                    else 
                    {
                        $('#divPast').append(generateEmptyGrid());
                    }

                    $('#divParentPast').show();
                }
                else
                {
                    $('#divParentPast').hide();
                }


                $('#ddlViewSelection').html(sViewName);
             }
         });
    }

    function generateAppointmentGrid(dataObj, statusText, statusBGColor, statusTextColor)
    {   
        var sBGColor = '#1e76fc';
        if (dataObj.status == 1)
        {
            sBGColor = '#c6c6c6';
        }

        var sRemarks = '';
        var sUpdateFtn = '';
        sUpdateFtn = '<a onclick="editButton(\'' + dataObj.appointmentID + '\')" style="cursor: pointer;">' +
                     '<i class="bi bi-pencil ms-2 text-white"></i>' +
                     '</a>';

        if (dataObj.status == 3)
        {
            sRemarks = '<div class="row ms-1">' +
                       '<div class="col-md-12">' +
                       '<p class="mb-0" style="font-size: 12px; color: red;">*You have requested a new time</p>' +
                       '</div>' +
                       '</div>';
        }

        if (dataObj.status == 4)
        {
            sRemarks = '<div class="row ms-1">' +
                       '<div class="col-md-12">' +
                       '<p class="mb-0" style="font-size: 12px; color: red;">*Clinic requested a new time.</p>' +
                       '</div>' +
                       '</div>';

            sUpdateFtn = '<a onclick="responseButton(\'' + dataObj.appointmentID + '\', \'' + moment(dataObj.apptDate).format('DD/MM/YYYY') + '\', \'' + dataObj.apptStartTime + '\')" style="cursor: pointer;">' +
                         '<i class="bi bi-reply ms-2 text-white"></i>' +
                         '</a>';
        }

        if (dataObj.status == 1 || dataObj.status == 2)
        {
            sUpdateFtn = '';
        }


        var strHtml = '';
        strHtml = '<div class="col-md-6 mb-3" style="border: 0px solid black;">' +

                  '<div class="row ms-1" style="border: 0px solid black; background-color: ' + sBGColor + '; border-radius: 6px;">' +

                  '<div class="col-md-7" style="border: 0px solid black;">' +
                  '<div class="row mt-3 align-items-center" style="height: 30px; border: 0px solid black;">' +
                  '<label class="ms-2" style="font-size: 14px; font-weight: bold; color: white;">' + dataObj.servicesName + '</label>' +
                  '</div>' + 
                  '<div class="row mt-2 mb-2" style="border: 0px solid black;">' + 
                  '<span class="align-items-center ms-2">'  + 
                  '<img src="/Images/Icons/calendar_white.png" style="width: 20px; height: 20px;" />' +
                  '<label class="ms-2" style="font-size: 12px; color: white;">' + moment(dataObj.apptDate).format('DD/MM/YYYY') + '</label>'  +
                  '</span>' +
                  '</div>' +
                  '<div class="row mb-2" style="border: 0px solid black;">' +
                  '<span class="align-items-center ms-2">' +
                  '<img src="/Images/Icons/clock_white.png" style="width: 18px; height: 18px;" />' +
                  '<label class="ms-2" style="font-size: 12px; color: white;">'+ dataObj.apptStartTime + '</label>' +
                  '</span>'  + 
                  '</div>' +
                  '<div class="row mb-2">' +
                  '<label class="ms-2" style="font-size: 12px; color: white;">' + dataObj.inchargeDoctor + '</label>' +
                  '</div>' +
                  '<div class="row mb-3">' +
                  sUpdateFtn +
                  '</div>' +
                  '</div>' +

                  '<div class="col-md-5" style="border: 0px solid black;">' +
                  '<div class="row mt-3 align-items-center" style="height: 30px; border: 0px solid black;">' +
                  '<div class="ms-4 text-center" style="width: 60%; height: 100%; border-radius: 6px; border: 1px solid ' + statusBGColor + '; background-color: ' + statusBGColor + '; color: ' + statusTextColor + '; ">' +
                  '<label style="font-size: 11px; font-weight: bold;">' + statusText + '</label>' +
                  '</div>' +
                  '</div>' +
                  '</div>' +

                  '</div>' + 
                  sRemarks + 
                  '</div>';

        return strHtml;
    }

    function generateEmptyGrid()
    {
        var emptyHtml = '';
        emptyHtml = '<div class="col-md-6 mb-3" style="border: 0px solid black;">' +
                    '<div class="row ms-1" style="border: 1px dashed black; border-radius: 6px;">' +

                    '<div class="col-md-12">' +
                    '<div class="row">&nbsp;</div>' +
                    '<div class="row">&nbsp;</div>' +
                    '<div class="row" style="color: grey;"><h3 class="text-center">No record</h3></div>' +
                    '<div class="row">&nbsp;</div>' +
                    '<div class="row">&nbsp;</div>' +
                    '<div class="row">&nbsp;</div>' +
                    '</div>' +

                    '</div>' +
                    '</div>';

        return emptyHtml;
    }

    function editButton(appointmentID)
    {
        window.location.href = '/Appointment/Details/' + appointmentID;
    }

    function responseButton(apptID, apptDate, apptStartTime)
    {
        var strContent = '';
        strContent = 'Clinic has requested for ###<newTIME>### on ###<newDATE>###. Would you like to accept it?';
        strContent = strContent.replace("###<newTIME>###", apptStartTime)
                               .replace("###<newDATE>###", apptDate);

        $('#divRespContent').html(strContent);
        $('#hidApptID').val(apptID);

        $('#responseModal').modal('show');
    }

    function acceptAppointment()
    {
        $.post("/Appointment/ConfirmedAppointment", {
            appointmentID: $('#hidApptID').val(),
            sUpdatedBy : '@sessionUserName'
        }).done(function(result){ 
            if (result){
                $('#responseModal').modal('hide');

                window.location.reload();
            }
            else{
                ShowSuccessMsgBox("Appointment Accepted", "Failed to accept appointment, please try again.",
                    function(){
                        $('#responseModal').modal('hide');
                    }
                );
            }
        });
    }

    function proposeAppointment()
    {
        window.location.href = '/Appointment/Details/' + $('#hidApptID').val();
    }

    function submitAppointment()
    {
        if (ValidAppointmentSubmit())
        {
            $.post("/Appointment/SubmitAppointment", {
                branchID: $('#ddlClinic').val(),
                appointmentDate: $('#dtDate').val(),
                appointmentStartTime: $('#tmStart').val(),
                appointmentEndTime: $('#tmEnd').val(),
                ownerID: '@sessionPatientOwnerID',
                petID: $('#ddlPets').val(),
                doctorID: $('#ddlDoctor').val(),
                inchargeDoctor: $('#ddlDoctor option:selected').text(),
                serviceID: $('#ddlServices').val(),
                submittedBy: '@sessionUserName'
            }).done(function(result) { 
                if (result){
                    alert('success');
                }
                else {
                    alert('fail');
                }
            });
        }
        else
        {
            $('#lbError').html('Mandatory fields required.');
        }
    }

    function ValidAppointmentSubmit()
    {
        $('#lbError').html('');
        let isValid = true;

        if ($('#ddlPets').val() == '')
        {
            $('#ddlPets').addClass("errorValidation");
            $('#ddlPets').focus();

            isValid = false;
        }
        else
        {
            $('#ddlPets').removeClass("errorValidation");
        }

        if ($('#ddlClinic').val() == '')
        {
            $('#ddlClinic').addClass("errorValidation");
            $('#ddlClinic').focus();

            isValid = false;
        }
        else 
        {
            $('#ddlClinic').removeClass("errorValidation");
        }

        if ($('#ddlServices').val() == '')
        {
            $('#ddlServices').addClass("errorValidation");
            $('#ddlServices').focus();

            isValid = false;
        }
        else 
        {
            $('#ddlServices').removeClass("errorValidation");
        }

        if ($('#ddlDoctor').val() == '')
        {
            $('#ddlDoctor').addClass("errorValidation");
            $('#ddlDoctor').focus();

            isValid = false;
        }
        else 
        {
            $('#ddlDoctor').removeClass("errorValidation");
        }

        if ($('#dtDate').val() == '')
        {
            $('#dtDate').addClass("errorValidation");
            $('#dtDate').focus();

            isValid = false;
        }
        else 
        {
            $('#dtDate').removeClass("errorValidation");
        }

        if ($('#tmStart').val() == '')
        {
            $('#tmStart').addClass("errorValidation");
            $('#tmStart').focus();

            isValid = false;
        }
        else 
        {
            $('#tmStart').removeClass("errorValidation");
        }

        if ($('#tmEnd').val() == '')
        {
            $('#tmEnd').addClass("errorValidation");
            $('#tmEnd').focus();

            isValid = false;
        }
        else 
        {
            $('#tmEnd').removeClass("errorValidation");
        }

        return isValid;
    }
</script>

<div class="row ms-3">
    <div class="row pt-4">
        <label class="pageTitle">Appointment</label>
    </div>
    <div class="row mt-2" style="border:0px solid black">
        <div class="col-md-9 d-flex justify-content-end">
            <label class="align-content-center" style="font-size: 14px; font-weight: bold;">View :</label>
            <div class="dropdown">
                <button id="ddlViewSelection" class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 14px;">
                </button>
                <ul id="ulViewSelection" class="dropdown-menu" aria-labelledby="ddlViewSelection">
                    <li><a class="dropdown-item" onclick="LoadAppointments('All', 'All')">All</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-3">
            &nbsp;
        </div>
    </div>
    <div class="row" style="border: 0px solid black;">
        <div class="col-md-9" style="border: 0px solid black;">
            <div id="divParentRescheduled" class="row" style="border: 0px solid black;">
                <div class="row">
                    <div class="col-md-12">
                        <label class="ms-1" style="font-size: 14px; font-weight: bold;">Rescheduled Appointments</label>
                    </div>
                </div>
                <div id="divRescheduled" class="row">
                    <!--
                    <div class="col-md-6 mb-3" style="border: 0px solid black;">
                        <div class="row ms-1" style="border: 0px solid black; background-color: #1e76fc; border-radius: 6px;">
                            <div class="col-md-7" style="border: 0px solid black;">
                                <div class="row mt-2 align-items-center" style="height: 30px;">
                                    <label class="ms-2" style="font-size: 14px; font-weight: bold; color: white;">Vaccinnation</label>
                                </div>
                                <div class="row mt-2 mb-2" style="border: 0px solid black;">
                                    <span class="align-items-center ms-2">
                                        <img src="~/Images/Icons/calendar_white.png" style="width: 20px; height: 20px;" />
                                        <label style="font-size: 12px; color: white;">08/04/2025</label>
                                    </span>

                                </div>
                                <div class="row mb-2" style="border: 0px solid black;">
                                    <span class="align-items-center ms-2">
                                        <img src="~/Images/Icons/clock_white.png" style="width: 18px; height: 18px;" />
                                        <label style="font-size: 12px; color: white;">14:00</label>
                                    </span>
                                </div>
                                <div class="row mb-3">
                                    <label class="ms-2" style="font-size: 12px; color: white;">Dr. Kim Ji woon</label>
                                </div>
                                <div class="row mb-3">
                                    <label class="ms-2" style="font-size: 12px;">Respond</label>
                                </div>
                            </div>
                            <div class="col-md-5" style="border: 0px solid black;">
                                <div class="row mt-2 align-items-center" style="height: 30px;">
                                    <div class="ms-4 align-items-center" style="border: 1px solid black; width: 60%; height: 100%; border-radius: 6px;">
                                        <label>Status</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    -->

                    <!-- CONTENT -->
                </div>
            </div>
            <div id="divParentConfirmed" class="row" style="border: 0px solid black;">
                <div class="row">
                    <div class="col-md-12">
                        <label class="ms-1" style="font-size: 14px; font-weight: bold;">Confirmed Appointments</label>
                    </div>
                </div>
                <div id="divConfirmed" class="row">
                    <!-- CONTENT -->
                </div>
            </div>
            <div id="divParentPast" class="row" style="border: 0px solid black;">
                <div class="row">
                    <div class="col-md-12">
                        <label class="ms-1" style="font-size: 14px; font-weight: bold;">Past Appoointments</label>
                    </div>
                </div>
                <div id="divPast" class="row">
                    <!-- CONTENT -->
                </div>
            </div>
        </div>
        <div class="col-md-3" style="border: 0px solid red;">
            <div class="row">
                <div class="col-md-12 mt-4" style="border: 0px solid black; background-color: #f7f7f7; border-radius: 6px;">
                    <div class="row mt-3 ms-1">
                        <label style="font-size: 18px; font-weight: bold;">Book Appointment</label>
                    </div>
                    <div class="row mt-4 ms-1">
                        <label style="font-size: 14px; font-weight: bold;">Pets</label>
                    </div>
                    <div class="row ms-2 me-1">
                        <select id="ddlPets" class="form-select form-select-sm">
                            <option value="">Select Pet</option>
                        </select>
                    </div>
                    <div class="row mt-3 ms-1">
                        <label style="font-size: 14px; font-weight: bold;">Clinic</label>
                    </div>
                    <div class="row ms-2 me-1">
                        <select id="ddlClinic" class="form-select form-select-sm" onchange="LoadServicesDropdownList(this);">
                            <option value="">Select Clinic</option>
                        </select>
                    </div>
                    <div class="row mt-3 ms-1">
                        <label style="font-size: 14px; font-weight: bold;">Services</label>
                    </div>
                    <div class="row ms-2 me-1">
                        <select id="ddlServices" class="form-select form-select-sm" onchange="LoadDoctorDropdownList(this);">
                            <option value="">Select Service</option>
                        </select>
                    </div>
                    <div class="row mt-3 ms-1">
                        <label style="font-size: 14px; font-weight: bold;">Doctor</label>
                    </div>
                    <div class="row ms-2 me-1">
                        <select id="ddlDoctor" class="form-select form-select-sm">
                            <option value="">Select Doctor</option>
                        </select>
                    </div>
                    <div class="row mt-3 ms-1">
                        <label style="font-size: 14px; font-weight: bold;">Date & Time</label>
                    </div>
                    <div class="row ms-0 me-0">
                        <div class="mb-0">
                            <input id="dtDate" class="form-control-sm" />
                        </div>
                        <div class="mt-0" style="display: flex; flex-direction: row; height: 30px; ">
                            <input id="tmStart" class="form-control-sm" style="width: 40%; border: 1px solid #ddd;" />
                            <div style="width: 20%; text-align: center; color: grey">--</div>
                            <input id="tmEnd" class="form-control-sm" style="width: 40%; border: 1px solid #ddd;" />
                        </div>
                    </div>
                    <div class="row">&nbsp;</div>
                    <div class="row ms-2">
                        <label id="lbError" style="color: red; font-size: 12px; font-weight: bold;"></label>
                    </div>
                    <div class="row ms-2 me-1 mb-5">
                        <button id="btnBook" class="btn btn-primary" style="font-size: 12px;" onclick="submitAppointment();">
                            Book Appointment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="responseModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row mt-3 ms-3 me-3 mb-3">
                    <div class="col-md-12 align-items-center">
                        <div id="divRespContent" class="row">
                            <!-- CONTENT -->
                        </div>
                        <div class="row mt-2 align-items-center">
                            <button id="btnNew" class="btn btn-secondary" onclick="proposeAppointment()" style="width: 45%; font-size: 12px;">Suggest New</button>&nbsp;
                            <button id="btnAccept" class="btn btn-primary" onclick="acceptAppointment();" style="width: 45%; font-size: 12px;">Accept</button> 
                            
                            <input id="hidApptID" type="hidden" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

