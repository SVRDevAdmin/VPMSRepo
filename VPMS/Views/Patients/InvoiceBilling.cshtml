@model VPMS.Lib.Data.Models.Pets;
@inject IHttpContextAccessor httpContextaccessor
@using Microsoft.AspNetCore.Localization
@inject VPMSWeb.Interface.IResourcesLocalizer LangResources

@{
	ViewData["Title"] = "Patients Page";
	ViewBag.SelectedMenu = "patientsMenu";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js" integrity="sha512-YcsIPGdhPK4P/uRW6/sruonlYj+Q7UHWeKfTAkBW+g83NKM+jMJFJ4iAPfSnVp7BKD4dKMHmVSvICUbE/V1sSw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<style>
	.field-container {
		display: flex;
		flex-direction: column;
		margin-left: 1.5vw;
		margin-right: 1.5vw;
	}

	.formlabel {
		font-weight: bold;
		margin-bottom: 0.3vw;
		font-size: 1vw;
	}

	.inputField {
		border: 0.1vw solid;
		font-size: 1vw;
	}

	.halfSize {
		width: 36vw;
	}

	.quaterSize {
		width: 8.5vw;
	}

	/* circle-icon */
	#container {
		width: 1.6vw;
		height: 1.6vw;
		display: flex;
		background: transparent;
		border-radius: 2vw;
		color: blue;
		border: 0.15vw solid;
		font-size: 1.5vw;
		justify-content: center;
		align-items: center;
	}
</style>

<div style="display: flex;">

	<div style="display: flex; align-items: center; margin-bottom: 1.5vw;">
		<img id="imgBackArrow" style=" margin-right: 1vw; width: 1.5vw;" onclick="location.href='/Patients/PetProfile/View/@ViewBag.PatientID/@Model.Name'" />
		<span class="textColor" style="font-size: 2vw;">@LangResources["Patient_Title_Patients"]</span>
		<span class="textColor" style="font-size: 2vw; margin-left:1vw; margin-right:1vw; font-weight: bold;"> &#62; </span>
		<span class="textColor" style="font-size: 2vw;">@LangResources["Patient_Title_PatientProfile"]</span>
		<span class="textColor" style="font-size: 2vw; margin-left:1vw; margin-right:1vw; font-weight: bold;"> &#62; </span>
		<span class="textColor" style="font-size: 2vw;">@ViewData["PetName"] @LangResources["Patient_Title_Profile"]</span>
		<span class="textColor" style="font-size: 2vw; margin-left:1vw; margin-right:1vw; font-weight: bold;"> &#62; </span>
		<span style="font-size: 2vw; color: dodgerblue;">@LangResources["Patient_Label_InvoiceBilling"]</span>
	</div>
</div>


<div style="display: flex; justify-content: center;">
	<div id="LeftInfoContainer" style="overflow: auto; height: 74vh; margin-right: 1vw; width: 51vw;">
		<div style="margin: 2vw; background-color: whitesmoke; padding: 1vw; border-radius: 0.5vw;">
			<table style="font-size: 1vw; width: 100%;">
				<tr style="border-bottom: 0.1vw solid; border-bottom-color: lightgray;">
					<th style="padding: 0.5vw 2vw; font-weight: bold;">Receipt No</th>
					<th style="padding: 0.5vw 2vw; font-weight: bold;">@LangResources["Patient_Label_Date"]</th>
					<th style="padding: 0.5vw 2vw; font-weight: bold;">Fee ($)</th>
					<th style="padding: 0.5vw 2vw; font-weight: bold;">@LangResources["Patient_Label_Status"]</th>
					<th style="padding: 0.5vw 2vw; font-weight: bold;">Action</th>
				</tr>
				<tr>
					<td style="padding: 0.5vw 2vw;">#123456</td>
					<td style="padding: 0.5vw 2vw;">10/04/2024 10:10</td>
					<td style="padding: 0.5vw 2vw;">848</td>
					<td style="padding: 0.5vw 2vw; color: red;">Pending</td>
					<td style="padding: 0.5vw 2vw;"><a href="#">@LangResources["Patient_Button_View"]</a></td>
				</tr>
				<tr>
					<td style="padding: 0.5vw 2vw;">#123456</td>
					<td style="padding: 0.5vw 2vw;">10/04/2024 10:10</td>
					<td style="padding: 0.5vw 2vw;">100</td>
					<td style="padding: 0.5vw 2vw; color: blue;">Ready</td>
					<td style="padding: 0.5vw 2vw;"><a href="#">@LangResources["Patient_Button_View"]</a></td>
				</tr>
			</table>
		</div>
	</div>

	<div id="RightInfoContainer" style="margin-left: 1.5vw; overflow: auto; height: 74vh; width: 24vw;">
		<div>

			<div class="containerBackground2" style="width: 23vw; padding: 0.7vw; padding-left: 1.5vw; border-top-left-radius: 0.5vw; border-top-right-radius: 0.5vw;">
				<span class="formlabel" style="margin-bottom: 0 !important;">@LangResources["Patient_Title_PetInfo"]</span>
			</div>
			<div class="containerBorder" style="color: darkgray; width: 23vw; border-style: solid; border-bottom-left-radius: 0.5vw; border-bottom-right-radius: 0.5vw; padding: 2vw; padding-left: 1vw; padding-right: 1vw; padding-bottom: 0.5vw; margin-bottom: 2vw; display: flex;">

				<div>
					<img src="~/images/Cat profile image.png" style="width: 4vw;" />
				</div>

				<div>
					<div style="display: flex; margin-bottom: 1.5vw;">
						<div class="field-container quaterSize">
							<span class="formlabel">@LangResources["Patient_Label_PetName"]</span>
							<span class="formlabel textColor">@Model.Name</span>
						</div>

						<div class="field-container">
							<span class="formlabel">@LangResources["Patient_Label_Sex"]</span>
							<span class="formlabel textColor">@(Model.Gender == "M" ? "Male" : "Female")</span>
						</div>
					</div>

					<div style="display: flex; margin-bottom: 1.5vw;">
						<div class="field-container quaterSize">
							<span class="formlabel">@LangResources["Patient_Label_RegistrationNo"]</span>
							<span class="formlabel textColor">@Model.RegistrationNo</span>
						</div>
					</div>
				</div>

			</div>

			<div class="containerBackground2" style="width: 23vw; padding: 0.7vw; padding-left: 1.5vw; border-top-left-radius: 0.5vw; border-top-right-radius: 0.5vw;">
				<span class="formlabel" style="margin-bottom: 0 !important;">@LangResources["Patient_Title_AdditionalInformation"]</span>
			</div>
			<div class="containerBorder textColor" style="color: darkgray; width: 23vw; border-style: solid; border-bottom-left-radius: 0.5vw; border-bottom-right-radius: 0.5vw; padding: 2vw; padding-left: 0.5vw; padding-right: 0.5vw; padding-bottom: 0.5vw; margin-bottom: 2vw;">

				<div style="display: flex; margin-bottom: 1.5vw;">
					<div class="field-container quaterSize" style="display: flex; align-items: center;">
						<button class="btn btn-lg btn-primary" data-bs-toggle="modal" data-bs-target="#healthCardModal" style="width: 5vw; height: 4vw; font-size: 2vw; display: flex; justify-content: center;  align-items: center;">
							<i class="fa-solid fa-notes-medical"></i>
						</button>
						<span class="formlabel textColor" style="text-wrap: nowrap;">@LangResources["Patient_Label_HealthCard"]</span>
					</div>
					<div class="field-container quaterSize" style="display: flex; align-items: center;">
						<button class="btn btn-lg btn-primary" onclick="window.location = '/Patients/TreatmentPlan/@ViewBag.PatientID/@ViewData["PetName"]';" style="width: 5vw; height: 4vw; font-size: 2vw; display: flex; justify-content: center;  align-items: center;">
							<i class="fa-regular fa-hospital"></i>
						</button>
						<span class="formlabel textColor" style="text-wrap: nowrap;">@LangResources["Patient_Label_TreatmentPlan"]</span>
					</div>
				</div>

				<div style="display: flex; margin-bottom: 1.5vw;">
					<div class="field-container quaterSize" style="display: flex; align-items: center;">
						<button class="btn btn-lg btn-primary" onclick="window.location = '/Patients/InvoiceBilling/@ViewBag.PatientID/@ViewData["PetName"]';" style="width: 5vw; height: 4vw; font-size: 2vw; display: flex; justify-content: center;  align-items: center;">
							<i class="fa-solid fa-receipt"></i>
						</button>
						<span class="formlabel textColor" style="text-wrap: nowrap;">@LangResources["Patient_Label_InvoiceBilling"]</span>
					</div>
					<div class="field-container quaterSize" style="display: flex; align-items: center;">
						<button class="btn btn-lg btn-primary" style="width: 5vw; height: 4vw; font-size: 2vw; display: flex; justify-content: center;  align-items: center;">
							<i class="fa-solid fa-flask-vial"></i>
						</button>
						<span class="formlabel textColor" style="text-wrap: nowrap;">@LangResources["Patient_Label_TestManagement"]</span>
					</div>
				</div>




			</div>

			<div class="containerBackground2" style="width: 23vw; padding: 0.7vw; padding-left: 1.5vw; border-top-left-radius: 0.5vw; border-top-right-radius: 0.5vw;">
				<span class="formlabel" style="margin-bottom: 0 !important;">@LangResources["Patient_Title_UpcomingAppointment"]</span>
			</div>
			<div class="containerBorder" id="UpcomingAppointment" style="background-color: #c8dcfc; color: darkgray; width: 23vw; border-style: none; border-bottom-left-radius: 0.5vw; border-bottom-right-radius: 0.5vw; padding: 2vw; padding-left: 0.5vw; padding-right: 0.5vw; padding-bottom: 0.4vw;">
			</div>
		</div>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="healthCardModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="--bs-modal-width: unset; margin: 2vw auto;">

	<style>
		.hideContainer {
			display: none !important;
		}

		@@media print {
			/* All your print styles go here */
			.printFont {
				font-size: 2vw !important;
			}

			.printImg {
				width: 10vw !important;
			}
		}

		.modal-content-custom {
			border: 0.1vw solid !important;
			padding: 1vw;
		}
	</style>

	<div class="modal-dialog" style="margin: 0 auto; width: fit-content;">
		<div class="modal-content">
			<div class="modal-header" style="display: flex; justify-content: flex-end; --bs-modal-header-border-color: none; padding-bottom: 0;">
				<button type="button" onclick="downloadHealthCard();" style="margin-right: 1vw; display: flex; justify-content: center;  align-items: center; font-size: 1vw; width: 1vw;" class="btn btn-lg btn-primary" data-bs-dismiss="modal">
					<i class="fa-solid fa-download"></i>
				</button>
				<button type="button" onclick="printHealthCard();" style="display: flex; justify-content: center;  align-items: center; font-size: 1vw; width: 1vw;" class="btn btn-lg btn-primary" data-bs-dismiss="modal"><i class="fa-solid fa-print"></i></button>
			</div>
			<div class="modal-body" style="display: flex;">
				<div style="margin: 0 1vw;">
					<img class="printImg" src="~/images/Cat profile image.png" style="width: 6vw; margin-bottom: 2vw;" />

					<div style="display: flex; flex-direction: column; margin: 1vw 0;">
						<span class="printFont" style="color: darkgray; font-size: 1vw;">@LangResources["Patient_Label_PetName"]</span>
						<span class="printFont" style="color: black; font-size: 1vw;">@ViewData["PetName"]</span>
					</div>

					<div style="display: flex; flex-direction: column; margin: 1vw 0;">
						<span class="printFont" style="color: darkgray; font-size: 1vw;">@LangResources["Patient_Label_RegistrationNo"]:</span>
						<span class="printFont" style="color: black; font-size: 1vw;">@Model.RegistrationNo</span>
					</div>
				</div>

				<hr style="border: 0.1vw solid black; margin: 0 1vw;">

				<div>
					<div style="margin-bottom: 2vw; padding: 1vw;">
						<span class="printFont" style="font-weight: bold; font-size: 1vw; padding: 0 2vw;">@LangResources["Patient_Title_VaccinationTreatmentHistory"]</span>

						<table class="printFont" id="HealthCardHistory" style="font-size: 1vw; margin-top: 1vw;">
							<tr>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Date"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_VaccinationTreatment"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Name"]</th>
							</tr>
							@* <tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Rabbies Vaccinations</td>
								<td style="padding: 0 2vw;">Defensor 1 - Rabies</td>
							</tr>
							<tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Rabbies Vaccinations</td>
								<td style="padding: 0 2vw;">Defensor 1 - Rabies</td>
							</tr>
							<tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Rabbies Vaccinations</td>
								<td style="padding: 0 2vw;">Defensor 1 - Rabies</td>
							</tr>
							<tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Rabbies Vaccinations</td>
								<td style="padding: 0 2vw;">Defensor 1 - Rabies</td>
							</tr> *@
						</table>
					</div>

					<div style="margin: 2vw 0; padding: 1vw;">
						<span class="printFont" style="font-weight: bold; font-size: 1vw; padding: 0 2vw;">@LangResources["Patient_Title_MedicationHistory"]</span>

						<table class="printFont" id="HealthCardMedication" style="font-size: 1vw; margin-top: 1vw;">
							<tr>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Date"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_MedicationName"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Status"]</th>
							</tr>
							@* <tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Prednisalone Suspension 5mg|10ml</td>
								<td style="padding: 0 2vw;">Active</td>
							</tr> *@
						</table>
					</div>

					<div style="margin: 2vw 0; background-color: whitesmoke; padding: 1vw; border-radius: 0.5vw;">
						<span class="printFont" style="font-weight: bold; font-size: 1vw; padding: 0 2vw;">@LangResources["Patient_Title_UpcomingVaccinationTreatment"]</span>

						<table class="printFont" id="HealthCardUpcoming" style="font-size: 1vw; margin-top: 1vw;">
							<tr>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Date"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_VaccinationTreatment"]</th>
								<th style="color: darkgray; padding: 0 2vw;">@LangResources["Patient_Label_Name"]</th>
							</tr>
							@* <tr>
								<td style="padding: 0 2vw;">01/09/2023</td>
								<td style="padding: 0 2vw;">Rabbies Vaccinations</td>
								<td style="padding: 0 2vw;">Defensor 1 - Rabies</td>
							</tr> *@
						</table>
					</div>

				</div>
			</div>
		</div>
	</div>

</div>

<script>
	getUpcomingTreatmentPlan();
	GetVaccinationTreatmentList(0, false);
	GetHealthCardMedicationList();
	GetUpcomingAppointment();

	function downloadHealthCard() {
		var clone = document.getElementById("healthCardModal").cloneNode(true);
		clone.querySelector(".modal-header").classList.toggle("hideContainer");
		clone.querySelector(".modal-content").classList.toggle("modal-content-custom");
		var element = clone.querySelector(".modal-dialog");

		var opt = {
			margin: 1,
			filename: '@ViewData["PetName"] - Health Card.pdf',
			image: { type: 'jpeg', quality: 0.98 },
			html2canvas: { scale: 2 },
			jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
		};

		html2pdf().set(opt).from(element).save();
	}

	function printHealthCard() {
		var iframe = document.createElement("iframe"); // create the element
		document.body.appendChild(iframe);  // insert the element to the DOM

		var clone = document.getElementById("healthCardModal").cloneNode(true);
		clone.querySelector(".modal-header").classList.toggle("hideContainer");
		clone.querySelector(".modal-content").classList.toggle("modal-content-custom");

		var input = clone.innerHTML;

		iframe.contentWindow.document.write(input); // write the HTML to be printed
		iframe.contentWindow.print();  // print it
		document.body.removeChild(iframe); // remove the iframe from the DOM
	}

	function getUpcomingTreatmentPlan() {
		fetch('/Patients/GetUpcomingTreatmentPlan?petID=@Model.ID')
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				return response.json();
			})
			.then(data => {
				GetVaccinationTreatmentList(data.ID, true);
			})
			.catch(error => {
				console.error('There was a problem with the fetch operation:', error);
			});
	}

	function GetVaccinationTreatmentList(id, upcoming) {
		fetch('/Patients/GetVaccinationTreatmentList?planID=' + id + '&upcoming=' + upcoming + '&petID=@Model.ID')
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				return response.json();
			})
			.then(data => {
				var tableElement;

				if (upcoming) {
					tableElement = document.getElementById("HealthCardUpcoming");
				}
				else {
					tableElement = document.getElementById("HealthCardHistory");
				}


				if (data.length == 0) {
					tableElement.innerHTML = tableElement.innerHTML + '<tr> <td colspan="3" style="text-align: center;"> @LangResources["Patient_Message_NoRecord"] <td> </tr>';
				}
				else {
					for (let i = 0; i < data.length; i++) {
						var date = new Date(data[i].Date);

						var dateText = [
							('0' + date.getDate()).slice(-2),
							('0' + (date.getMonth() + 1)).slice(-2),
							date.getFullYear()
						].join('/');

						tableElement.innerHTML = tableElement.innerHTML +
							'<tr>' +
							'<td style="padding: 0 2vw;"> ' + dateText + '</td>' +
							'<td style="padding: 0 2vw;">' + data[i].CategoryName + '</td>' +
							'<td style="padding: 0 2vw;">' + data[i].ServiceName + '</td>' +
							'</tr > '
					}
				}

			})
			.catch(error => {
				console.error('There was a problem with the fetch operation:', error);
			});
	}

	function GetHealthCardMedicationList() {
		fetch('/Patients/GetHealthCardMedicationList?petID=@Model.ID')
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				return response.json();
			})
			.then(data => {
				var tableElement = document.getElementById("HealthCardMedication");


				if (data.length == 0) {
					tableElement.innerHTML = tableElement.innerHTML + '<tr> <td colspan="3" style="text-align: center;"> @LangResources["Patient_Message_NoRecord"] <td> </tr>';
				}
				else {
					for (let i = 0; i < data.length; i++) {
						var date = new Date(data[i].Date);

						var dateText = [
							('0' + date.getDate()).slice(-2),
							('0' + (date.getMonth() + 1)).slice(-2),
							date.getFullYear()
						].join('/');

						var status = data[i].Status == 1 ? "Active" : "Inactive";

						tableElement.innerHTML = tableElement.innerHTML +
							'<tr>' +
							'<td style="padding: 0 2vw;"> ' + dateText + '</td>' +
							'<td style="padding: 0 2vw;">' + data[i].Name + '</td>' +
							'<td style="padding: 0 2vw;">' + status + '</td>' +
							'</tr > '
					}
				}

			})
			.catch(error => {
				console.error('There was a problem with the fetch operation:', error);
			});
	}

	function GetUpcomingAppointment() {
		fetch('/Appointment/GetUpcomingAppointment?ownerID=0&petID=@Model.ID')
			.then(response => {
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(data => {
				var element = document.getElementById("UpcomingAppointment");

				if (data.PetName == null) {
					element.innerHTML = '<div style="margin-bottom: 1.5vw; text-align: center;">No Upcoming Appointment</div>'
				} else {

					var date = new Date(data.ApptDate);

					var dateText = [
						('0' + date.getDate()).slice(-2),
						('0' + (date.getMonth() + 1)).slice(-2),
						date.getFullYear()
					].join('/');

					var time = data.ApptStartTime.slice(0, -3) + " - " + data.ApptEndTime.slice(0, -3)

					element.innerHTML =
						'<div style="display: flex; margin-bottom: 1.5vw;">' +
						'<div class="field-container quaterSize" >' +
						'<span class="formlabel">@LangResources["Patient_Label_Date"]</span>' +
						'<span class="formlabel" style="color: black;">' + dateText + '</span>' +
						'</div >' +

						'<div class="field-container quaterSize">' +
						'<span class="formlabel">@LangResources["Patient_Label_Time"]</span>' +
						'<span class="formlabel" style="color: black;">' + time + '</span>' +
						'</div>' +
						'</div >' +


						'<div style="display: flex; margin-bottom: 1.5vw;">' +
						'<div class="field-container quaterSize">' +
						'<span class="formlabel">@LangResources["Patient_Label_Pet"]</span>' +
						'<span class="formlabel" style="color: black;">' + data.PetName + '</span>' +
						'</div>' +

						'<div class="field-container quaterSize">' +
						'<span class="formlabel">@LangResources["Patient_Label_Service"]</span>' +
						'<span class="formlabel" style="color: black;">' + data.Service + '</span>' +
						'</div>' +
						'</div>' +


						'<div style="display: flex; margin-bottom: 1.5vw;">' +
						'<div class="field-container quaterSize">' +
						'<span class="formlabel">@LangResources["Patient_Label_Doctor"]</span>' +
						'<span class="formlabel" style="color: black;">' + data.Doctor + '</span>' +
						'</div>' +
						'</div>';
				}

			})
			.catch(error => {
				console.error('There was a problem with the fetch operation:', error);
			});
	}
</script>