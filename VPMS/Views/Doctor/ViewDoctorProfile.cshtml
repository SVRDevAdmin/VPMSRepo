@inject VPMSWeb.Interface.IResourcesLocalizer LangResources
@inject IHttpContextAccessor httpContextaccessor
@model VPMS.Lib.Data.Models.DoctorModel

@{
    ViewData["Title"] = "ViewDoctorProfile";
    ViewData["SelectedMenu"] = "doctorMenu";

    var sessionUserName = httpContextaccessor.HttpContext.Session.GetString("LoginID");
    var sessionBranchID = httpContextaccessor.HttpContext.Session.GetString("BranchID");
    var sessionLevel = httpContextaccessor.HttpContext.Session.GetString("Level");
    var sessionIsAdmin = httpContextaccessor.HttpContext.Session.GetString("IsAdmin");
    var sessionOrganizationID = httpContextaccessor.HttpContext.Session.GetString("OrganisationID");

    var sDoctorObj = new VPMS.Lib.Data.Models.DoctorDetailModel();
    if (ViewData["DoctorProfile"] != null)
    {
        sDoctorObj = ViewData["DoctorProfile"] as VPMS.Lib.Data.Models.DoctorDetailModel;
    }

    var strServiceList = "";
    var sServList = new List<VPMS.Lib.Data.Models.DoctorServicesExtendedModel>();
    if (ViewData["DoctorServices"] != null)
    {
        sServList = ViewData["DoctorServices"] as List<VPMS.Lib.Data.Models.DoctorServicesExtendedModel>;
        strServiceList = String.Join(",", sServList.Distinct().Select(x => x.ServicesID.Value));
    }

    var lstServices = new System.Collections.ObjectModel.ObservableCollection<VPMS.Lib.Data.Models.ServiceList>();
    if (ViewData["ServicesList"] != null)
    {
        lstServices = ViewData["ServicesList"] as System.Collections.ObjectModel.ObservableCollection<VPMS.Lib.Data.Models.ServiceList>;
    }

    var sViewType = ViewData["ViewType"] as String;
}

<link rel="stylesheet" href="~/css/Doctor.css" />

<script>
    $(document).ready(function () {
        loadGenderDropdownlist();
        loadOrganizationDropdownlist();

        $('#hidServiceLst').val('@strServiceList');

        /*---- Add Button -------*/
        $('#btnCreate').on('click', function (ctl) {
            
            if (DoctorFieldsValidation()) 
            {
                let lstServicesSelected = [];
                $("input:checkbox[name=chkservices]:checked").each(function(){
                   lstServicesSelected.push($(this).attr('data-target'));
                });

                var sNewDoctorObj = {
                    doctorName: $('#txtName').val(),
                    doctorGender: $('#ddlGender').val(),
                    licenseNo: $('#txtLicenseNo').val(),
                    systemID: $('#txtSystemID').val(),
                    designation: $('#txtDesignation').val(),
                    specialty: $('#txtSpecialty').val(),
                    branchID: $('#ddlBranch').val(),
                    serviceID: $('#ddlServices').val(),
                    createdBy: '@sessionUserName',
                    servicesLst: lstServicesSelected
                }

                $.post("/Doctor/AddDoctor",
                    sNewDoctorObj
                ).done(function (result) {
                    if (result.StatusCode == 200) {
                        ShowSuccessMsgBox("@Html.Raw(LangResources["DoctorProfile_Title_AddDoctor"])", 
                                          "@Html.Raw(LangResources["DoctorProfile_Message_DoctorAddedSuccessfully"])",
                            function () {
                                window.location.href = '/Doctor/Index';
                            }
                        )
                    }
                    else {
                        $('#lbError').html('@Html.Raw(LangResources["DoctorProfile_Message_FailedToAddDoctor"])');
                        $('#lbError').css('visibility', 'visible');
                    }
                });
            }
            else{
                $('#lbError').html('@Html.Raw(LangResources["DoctorProfile_Message_MandatoryFieldRequired"])');
                $('#lbError').css('visibility', 'visible');
            }

        });

        /*------- Cancel Button ------*/
        $('#btnCancel').on('click', function (ctl) {
            //clearFields();
            window.location.href = '/Doctor/Index';
        });

        /*-------- Update Button -------*/
        $('#btnUpdate').on('click', function (ctl) {

            if (DoctorFieldsValidation())
            {
                let lstServicesSelected = [];
                $("input:checkbox[name=chkservices]:checked").each(function(){
                   lstServicesSelected.push($(this).attr('data-target'));
                });

                var sUpdateDoctorObj = {
                    doctorName: $('#txtName').val(),
                    doctorGender: $('#ddlGender').val(),
                    licenseNo: $('#txtLicenseNo').val(),
                    systemID: $('#txtSystemID').val(),
                    designation: $('#txtDesignation').val(),
                    specialty: $('#txtSpecialty').val(),
                    ID: $('#hidID').val(),
                    branchID: $('#ddlBranch').val(),
                    updatedBy:  '@sessionUserName',
                    servicesLst: lstServicesSelected
                }

                $.post("/Doctor/UpdateDoctor",
                    sUpdateDoctorObj
                ).done(function (result) {
                    if (result.StatusCode == 200) {
                        ShowSuccessMsgBox("@Html.Raw(LangResources["DoctorProfile_Title_UpdateDoctor"])", 
                                          "@Html.Raw(LangResources["DoctorProfile_Message_UpdateDoctorSuccessfully"])",
                            function () {
                                window.location.href = '/Doctor/Index';
                            }
                        )
                    }
                    else {
                        $('#lbError').html('@Html.Raw(LangResources["DoctorProfile_Message_FailedToUpdateDoctor"])');
                        $('#lbError').css('visibility', 'visible');
                    }
                });
            }
            else{
                $('#lbError').html('@Html.Raw(LangResources["DoctorProfile_Message_MandatoryFieldRequired"])');
                $('#lbError').css('visibility', 'visible');
            }
        });

        /*------- Back Button ----------*/
        $('#btnBack').on('click', function (ctl) {
            window.location.href = '/Doctor/Index';
        });

        /*---- If contain variable --------*/
        if ('@ViewData["DoctorProfile"]' != '') {
            $('#txtName').val('@sDoctorObj.Name');

            setTimeout(function () {
                $("#ddlGender").val('@sDoctorObj.Gender');
                $("#ddlGender").trigger('changes');
            }, 250);


            $('#txtLicenseNo').val('@sDoctorObj.LicenseNo');
            $('#txtSystemID').val('@sDoctorObj.System_ID');
            $('#txtDesignation').val('@sDoctorObj.Designation');
            $('#txtSpecialty').val('@sDoctorObj.Specialty');
            $('#hidID').val('@sDoctorObj.ID');

            setTimeout(function(){
                $('#ddlOrganization').val('@sDoctorObj.OrganizationID');
                $('#ddlOrganization').trigger('changes');
                loadBranchDropdownlist($('#ddlOrganization').val());
            }, 250);

            setTimeout(function(){
                $('#ddlBranch').val('@sDoctorObj.BranchID');
                $('#ddlBranch').trigger('changes');
            }, 600);

            if ('@sessionLevel' == '2' && '@sessionIsAdmin' == '1')
            {
                $('#ddlOrganization').prop('disabled', true);
            }

            var $arryServ = $('#hidServiceLst').val().split(',');
            for (var i = 0; i < $arryServ.length; i++)
            {
                var sServiceItem = $('input[name=chkservices]');
                for (var z = 0; z < sServiceItem.length; z++)
                {
                    if (sServiceItem[z].attributes['data-target'].value == $arryServ[i])
                    {
                        sServiceItem[z].checked = true;
                    }
                }

                chkboxChanges();
            }

            $('#btnUpdate').show();
            $('#btnBack').show();

            $('#btnCreate').hide();
            $('#btnCancel').hide();

            if ('@sViewType' == "View") {
                $('#txtName').prop('disabled', true);
                $("#ddlGender").prop('disabled', true);
                $('#txtLicenseNo').prop('disabled', true);
                $('#txtSystemID').prop('disabled', true);
                $('#txtDesignation').prop('disabled', true);
                $('#txtSpecialty').prop('disabled', true);
                $('#ddlBranch').prop('disabled', true);
                $('#ddlOrganization').prop('disabled', true);

                $('#btnddlService').prop('disabled', true);

                $('#btnUpdate').hide();
            }
        }
        else {
            if ('@sessionLevel' == '2' && '@sessionIsAdmin' == '1')
            {
                setTimeout(function(){
                    $('#ddlOrganization').val('@sessionOrganizationID');
                    $('#ddlOrganization').trigger('changee');
                    $('#ddlOrganization').prop('disabled', true);

                    loadBranchDropdownlist('@sessionOrganizationID');
                }, 650);
            }
        }
    });

    function loadGenderDropdownlist() {
        $.getJSON("/Doctor/GetGenderListDropdown")
            .done(function (result) {
                if (result.length > 0) {

                    $('#ddlGender').find("option:not(:first)").remove();
                    for (var i = 0; i < result.length; i++) {
                        var opt = new Option(result[i].CodeName, result[i].CodeID);
                        $('#ddlGender').append(opt);
                    }

                }
                else {
                    $('#ddlGender').find("option:not(:first)").remove();
                }
            })
    }

    function loadOrganizationDropdownlist()
    {
        $.getJSON("/AccessControl/GetOrganisationByLevelID/2")
         .done(function(result){ 
             if (result != null && result.data.length > 0)
             {
                 $('#ddlOrganization').find("option:not(:first)").remove();

                 for (var i = 0; i < result.data.length; i++)
                 {
                     var opt = new Option((result.data[i].Name), result.data[i].Id);
                     $('#ddlOrganization').append(opt);
                 }
             }
             else 
             {
                $('#ddlOrganization').find("option:not(:first)").remove();
             }
         });
    }

    function ddlOrganizationChanges(org)
    {
        loadBranchDropdownlist(org.value);
    }

    function loadBranchDropdownlist(orgID)
    {
        $.getJSON("/AccessControl/GetBranchInfoByOrganisation", {
            organisationID: orgID
        }).done(function(result){ 
             if (result != null && result.length > 0)
             {
                 $('#ddlBranch').find("option:not(:first)").remove();
                 for (var i = 0; i < result.length; i++)
                 {
                     var opt = new Option((result[i].Name), result[i].ID);
                     $('#ddlBranch').append(opt);
                 }
             }
             else
             {
                $('#ddlBranch').find("option:not(:first)").remove();
             }
        });
    }

    function DoctorFieldsValidation(){
        $('#lbError').css('visiblity', 'hidden');
        let isValid = true;

        /*-------- Name Field --------*/
        if ($('#txtName').val() == ''){
            $('#txtName').addClass("errorValidation");
            $('#txtName').focus();

            isValid = false;
        }
        else{
            $('#txtName').removeClass("errorValidation");
        }

        /*------- Gender Selection -------*/
        if ($('#ddlGender').val() == '') {
            $('#ddlGender').addClass("errorValidation");
            $('#ddlGender').focus();

            isValid = false;
        }
        else 
        { 
            $('#ddlGender').removeClass("errorValidation");
        }

        /*------ license No. Field ---------*/
        if ($('#txtLicenseNo').val() == '')
        {
            $('#txtLicenseNo').addClass("errorValidation");
            $('#txtLicenseNo').focus();

            isValid = false;
        }
        else
        {
            $('#txtLicenseNo').removeClass("errorValidation");
        }

        /*------- Designation Field -------*/
        if ($('#txtDesignation').val() == '') {
            $('#txtDesignation').addClass("errorValidation");
            $('#txtDesignation').focus();

            isValid = false;
        }
        else {
            $('#txtDesignation').removeClass("errorValidation");
        }

        /*------- Specialty Field -----*/
        if ($('#txtSpecialty').val() == '') {
            $('#txtSpecialty').addClass("errorValidation");
            $('#txtSpecialty').focus();

            isValid = false;
        }
        else { 
            $('#txtSpecialty').removeClass("errorValidation");
        }

        if ($("input:checkbox[name=chkservices]:checked").length == 0)
        {
            $('#btnddlService').addClass("errorValidation");
            $('#btnddlService').focus();

            isValid = false;
        }
        else {
            $('#btnddlService').removeClass("errorValidation");
        }

        /*------- Organization --------*/
        if ($('#ddlOrganization').val() == ''){
            $('#ddlOrganization').addClass("errorValidation");
            $('#ddlOrganization').focus();

            isValid = false;
        }
        else {
             $('#ddlOrganization').removeClass("errorValidation");
        }

        /*-------- Branch -------------*/
        if ($('#ddlBranch').val() == ''){
            $('#ddlBranch').addClass("errorValidation");
            $('#ddlBranch').focus();

            isValid = false;
        }
        else {
             $('#ddlBranch').removeClass("errorValidation");
        }

        return isValid;
    }

    function clearFields()
    {
        $('#txtName').val('');
        $('#txtName').removeClass("errorValidation");

        $('#ddlGender').val($('#ddlGender option:first').val());
        $('#ddlGender').removeClass("errorValidation");

        $('#txtLicenseNo').val('');
        $('#txtLicenseNo').removeClass("errorValidation");

        $('#txtSystemID').val('');
        $('#txtSystemID').removeClass("errorValidation");

        $('#txtDesignation').val('');
        $('#txtDesignation').removeClass("errorValidation");

        $('#txtSpecialty').val('');
        $('#txtSpecialty').removeClass("errorValidation");

        $('#lbError').html('');
    }

    function chkboxChanges()
    {
        let selectedItems = [];
        let selectedText = '';

        $("input:checkbox[name=chkservices]:checked").each(function(){
            selectedItems.push($(this).attr('data-html'));
        });

        if (selectedItems.length > 0) {
            selectedText = selectedItems.join(', ');
        }
        else {
            selectedText = "@Html.Raw(LangResources["DoctorProfile_Label_SelectService"])";
        }

        $('#btnddlService').text(selectedText);
    }
</script>

<div class="row">
    <div class="row" style="height: 45px;">&nbsp;</div>
    <div class="row">
        <div class="col-md-12">
            <div class="row frameStyle">
                <div class="col-md-12 frameHeader">
                    <label class="frameHeaderLabel">
                        @LangResources["DoctorProfile_Title_DoctorDetails"]
                    </label>
                </div>
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-12">
                            &nbsp;
                            <input id="hidServiceLst" type="hidden" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="txtName" class="doctorLeftColLabel">@LangResources["DoctorProfile_Label_Name"]</label>
                            <input id="txtName" type="text" class="form-control doctorLeftColControl" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="ddlGender" class="doctorRightColLabel">@LangResources["DoctorProfile_Label_Gender"]</label>
                            <select id="ddlGender" class="form-select doctorRightColControl">
                                <option value="">@LangResources["DoctorProfile_Label_PleaseSelectGender"]</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="txtLicenseNo" class="doctorLeftColLabel">@LangResources["DoctorProfile_Label_LicenseNo"]</label>
                            <input id="txtLicenseNo" type="text" class="form-control doctorLeftColControl" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="txtSystemID" class="doctorRightColLabel">@LangResources["DoctorProfile_Label_SystemID"]</label>
                            <input id="txtSystemID" type="text" class="form-control doctorRightColControl" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <label for="txtDesignation" class="doctorLeftColLabel">@LangResources["DoctorProfile_Label_Designation"]</label>
                            <input id="txtDesignation" type="text" class="form-control doctorComboColControl" maxlength="200" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <label for="txtSpecialty" class="doctorLeftColLabel">@LangResources["DoctorProfile_Label_Specialty"]</label>
                            <input id="txtSpecialty" type="text" class="form-control doctorComboColControl" maxlength="200" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <label for="ddlServices" class="doctorLeftColLabel">
                                @LangResources["DoctorProfile_Label_Services"]
                            </label>

                            <div id="divServiceDropdown" class="dropdown" style="margin-left: 10px;">
                                <button id="btnddlService" class="btn btn-secondary dropdown-toggle" type="button" 
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    @LangResources["DoctorProfile_Label_SelectService"]
                                </button>
                                <div class="dropdown-menu" aria-labelledby="btnddlService">
                                    @{
                                        foreach (var s in lstServices)
                                        {
                                            <label class="dropdown-item">
                                                <input name="chkservices" type="checkbox" class="form-check-input" data-target="@s.ID" data-html="@s.Name" onchange="chkboxChanges();" />
                                                @s.Name
                                            </label>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="ddlOrganization" class="doctorLeftColLabel">@LangResources["DoctorProfile_Label_Organization"]</label>
                            <select id="ddlOrganization" class="form-select doctorLeftColControl" onchange="ddlOrganizationChanges(this);">
                                <option value="">@LangResources["DoctorProfile_Label_PleaseSelectOrganization"]</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ddlBranch" class="doctorRightColLabel">@LangResources["DoctorProfile_Label_Branch"]</label>
                            <select id="ddlBranch" class="form-select doctorRightColControl">
                                <option value="">@LangResources["DoctorProfile_Label_PleaseSelectBranch"]</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="height: 35px;">&nbsp;
                        <label id="lbError"></label>
                        <input id="hidID" type="text" style="visibility: hidden; font-size: 12px;" />
                    </div>
                    <div class="row" style="height: 30px;">
                        &nbsp;
                    </div>
                </div>
            </div>
            <div class="row doctorButtonRow" >
                <div class="col-md-12 doctorButtonBox" >
                    <button id="btnCancel" type="button" class="btn btn-secondary">@LangResources["DoctorProfile_Button_Cancel"]</button>
                    <button id="btnCreate" type="button" class="btn btn-primary">@LangResources["DoctorProfile_Button_Create"]</button>
                    <button id="btnBack" type="button" class="btn btn-secondary">@LangResources["DoctorProfile_Button_Back"]</button>
                    <button id="btnUpdate" type="button" class="btn btn-primary">@LangResources["DoctorProfile_Button_Update"]</button>
                </div>
            </div>
        </div>
    </div>
</div>
